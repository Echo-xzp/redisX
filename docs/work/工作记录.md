# 工作记录（Work Log）

此文档用于记录每次改动、实现决策与设计权衡。

## 初始提交（日期：2026-01-10）

- 初始化 Go 模块（`go.mod`）并创建基础目录结构：`cmd/`, `internal/server`, `internal/protocol`, `internal/storage`。
- 添加 `cmd/redisx/main.go`：程序入口，启动 TCP 服务器（默认监听 :6379）。
- 添加 `internal/server/server.go`：实现基础 TCP Accept 与连接处理骨架，支持简单 `PING` 响应。
- 添加 `internal/storage/storage.go`：实现线程安全的 `Storage`，支持 `Get`/`Set`/`Delete`/`Exists`（含懒删除过期检查）。
- 添加 `README.md`：说明如何运行项目。

### 决策记录
- 临时采用简单行读取并识别 `PING` 命令的方式来验证 TCP 与连接处理；后续将替换为完整的 RESP 解析器（见 `internal/protocol`）。
- `Storage` 使用 `sync.RWMutex` 保护 `map`，并实现懒删除策略以简化初期实现与测试。

### 下一步计划
- 实现 RESP 协议解析器并将 `server` 替换为使用解析器处理命令。
- 实现命令路由与 `SET/GET/DEL/EXISTS` 命令。
- 添加单元测试与集成测试。

## 更新 - INFO 命令与单元测试（日期：2026-01-10）

- 在 `internal/server/server.go` 中新增连接计数与 `INFO` 命令，返回服务器版本、连接数、键数量与运行时间。
- 为 `internal/storage` 添加 `Count()` 方法以便统计键数量。
- 添加单元测试：`internal/storage/storage_test.go`（测试 Set/Get/Delete/Exists/Expire/TTL/Count 与后台清理）和 `internal/protocol/resp_test.go`（测试行协议与 RESP 数组解析）。
- 运行 `go test ./...`，所有新增测试通过。
- 在 `internal/server` 中为 `SET` 命令添加 `EX`（秒）和 `PX`（毫秒，向上取整到秒）选项支持。  
- 添加服务器集成测试，验证 `SET` 带过期选项在过期前后返回正确的结果。  
- 更新 `README.md`（添加启动、redis-cli 示例、测试与构建说明）。

## 更新 - Go 版本与构建（日期：2026-01-10）

- 检测到开发环境 Go 版本：`go1.21.4`。
- 已将 `go.mod` 的 `go` 版本从 `1.19` 更新为 `1.21`。
- 执行 `go build ./...`，构建通过。

## 发布 - v0.1.0（日期：2026-01-10）

- 打包 release 二进制到 `release/` 目录（包含 linux/amd64、linux/arm64、darwin/amd64、windows/amd64）。
- 计算并记录 SHA256 校验和，详见 `RELEASE.md`。
- 提交发布说明与二进制（本地 commit），并创建本地 tag `v0.1.0`。  
- 初始化 Git 仓库并将 release 二进制与说明提交到本地仓库（tag: `v0.1.0`）。

## 更新 - 增强 RESP 解析器（日期：2026-01-10）

- 新增单元测试：`internal/protocol/resp_test.go` 包括 `TestParseNullBulk`（支持 `$-1` null bulk）、`TestPipelining`（连续解析多条 RESP 命令流）、`TestStrictLengthMismatch`（长度不匹配时报错）与 `TestInvalidBulkHeader`（非法 bulk header 报错）。
- 修改解析器实现：`internal/protocol/resp.go`，支持 `$-1`（将 null bulk 映射为空字符串以便上层处理）并在遇到小于 -1 的长度时返回错误，增强了边界校验与错误信息。
- 验证：运行 `go test ./...`，全部通过（protocol、server、storage 包测试通过）。
- 后续建议：增加 server 层的流水线集成测试以验证在真实 TCP 流中连续请求的处理与并发安全；在文档中明确 `$-1` 的语义（是否映射为空字符串或作为特殊 nil 值）。

## 更新 - 毫秒级过期支持（日期：2026-01-10）

- 实现 `PTTL` / `PEXPIRE` 命令并使 `SET PX` 支持毫秒级精度（不再向上取整为秒）。
- 修改 `internal/storage`：将过期时间以 Unix 毫秒存储，新增 `SetWithMs`、`PExpire`、`PTTL`，并调整 janitor 与 TTL 返回逻辑（TTL 依然返回秒）。
- 修改 `internal/server`：支持 `PEXPIRE`/`PTTL` 命令与 `SET PX` 毫秒行为。
- 新增单元与集成测试：`internal/storage` 与 `internal/server`（验证毫秒精度与并发情况）。
- 验证：运行 `go test ./...`，全部通过。

## 更新 - 新增 CONTRIBUTING（日期：2026-01-10）

- 新增文档：`docs/CONTRIBUTING.md`，包含项目宪法、Agent 行为规范、分支/提交/PR 约定、任务/工作流模板与快速启动命令。
- 目的：确保人工与自动 agent 启动时都能读取到一致的任务与行为规范；简化 agent 的启动检查与变更流程。
- 验证：`docs/CONTRIBUTING.md` 已添加到仓库，建议所有 agent 在每次运行前读取该文件并遵循其中步骤。