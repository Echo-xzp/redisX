# 第一阶段实施计划

## 文档说明

本文档基于《技术原理分析.md》和《技术实施可行性分析.md》，制定了第一阶段（MVP）的详细实施计划。第一阶段的目标是快速实现一个可用的类 Redis 缓存服务，支持基础命令，验证架构可行性。

**项目名称**：redisX  
**技术栈**：Go 语言  
**实施路径**：路径 A - Go 快速验证路径  
**目标**：4-7 周内完成 MVP 版本

---

## 1. 项目目标

### 1.1 功能目标

**核心功能：**
- 支持基础 Redis 命令：SET、GET、DEL、EXISTS
- 支持 Redis RESP 协议，可被标准 Redis 客户端连接
- 支持多客户端并发连接
- 支持键过期机制（EXPIRE、TTL）
- 基本的错误处理和日志

**暂不支持（后期实现）：**
- 哈希表、列表、集合、有序集合等复杂数据结构
- 持久化（RDB/AOF）
- 发布订阅
- 事务和 Lua 脚本
- 集群模式

### 1.2 技术目标

**性能目标（定性）：**
- 能够正常运行，响应客户端请求
- 支持至少 100+ 并发连接
- 基本功能稳定，无明显内存泄漏

**优化目标（第一阶段可选）：**
- 数据对齐优化（如果时间允许）
- CPU 亲和性绑定（如果时间允许）
- 简单内存池（如果时间允许）

### 1.3 质量目标

- 代码可读性和可维护性
- 基础的单元测试覆盖
- 能够通过 redis-cli 和主流 Redis 客户端连接测试

---

## 2. 技术架构概览

### 2.1 整体架构

```
┌─────────────────────────────────────────┐
│          Redis 客户端                    │
│     (redis-cli, jedis, etc.)            │
└──────────────┬──────────────────────────┘
               │ TCP 连接
               │ RESP 协议
┌──────────────▼──────────────────────────┐
│         网络层 (Network Layer)           │
│  - TCP 服务器                            │
│  - 连接管理                              │
│  - 事件循环 (goroutine per connection)  │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│       协议层 (Protocol Layer)            │
│  - RESP 解析器                           │
│  - 命令解析                              │
│  - 响应编码                              │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│       命令层 (Command Layer)             │
│  - 命令路由                              │
│  - 命令执行                              │
│  - SET/GET/DEL/EXISTS 实现              │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│       存储层 (Storage Layer)             │
│  - 哈希表 (map[string]*Entry)           │
│  - 过期键管理                            │
│  - 键值存储                              │
└─────────────────────────────────────────┘
```

### 2.2 技术栈

- **语言**：Go 1.19+
- **网络库**：标准库 `net` + goroutine
- **数据结构**：`map` + `sync.RWMutex`（第一阶段）
- **时间管理**：标准库 `time`（过期机制）
- **日志**：标准库 `log` 或 `logrus`（可选）

---

## 3. 详细任务分解

### Phase 1.1：项目基础搭建（Week 1）

#### 任务 1.1.1：项目结构搭建
**时间估算**：0.5 天

**交付物：**
- [ ] 初始化 Go 模块（`go mod init redisx`）
- [ ] 创建项目目录结构
  ```
  redisx/
  ├── cmd/
  │   └── redisx/          # 主程序入口
  ├── internal/
  │   ├── server/          # 服务器核心
  │   ├── protocol/        # RESP 协议
  │   ├── command/         # 命令处理
  │   ├── storage/         # 存储层
  │   └── config/          # 配置管理
  ├── pkg/                 # 可导出的包（如有）
  ├── test/                # 测试文件
  ├── docs/                # 文档（已有）
  ├── go.mod
  └── README.md
  ```
- [ ] 编写基础 README.md

#### 任务 1.1.2：TCP 服务器框架
**时间估算**：1 天

**交付物：**
- [ ] TCP 服务器启动和监听
- [ ] 客户端连接接收
- [ ] 连接管理（连接池、连接关闭）
- [ ] 基础日志输出

**技术要点：**
```go
// 伪代码示例
func (s *Server) Start() error {
    listener, err := net.Listen("tcp", s.addr)
    for {
        conn, err := listener.Accept()
        go s.handleConnection(conn)
    }
}
```

#### 任务 1.1.3：RESP 协议解析器
**时间估算**：2 天

**交付物：**
- [ ] RESP 协议解析器（支持简单字符串、批量字符串、数组）
- [ ] 命令解析（将 RESP 数组解析为命令和参数）
- [ ] 响应编码（将结果编码为 RESP 格式）
- [ ] 单元测试

**技术要点：**
- 支持 RESP 基本类型：`+`（简单字符串）、`$`（批量字符串）、`*`（数组）
- 错误处理：协议错误时返回 `-ERR` 响应

#### 任务 1.1.4：命令路由框架
**时间估算**：1 天

**交付物：**
- [ ] 命令注册机制
- [ ] 命令路由表
- [ ] 命令执行接口
- [ ] 未知命令的错误处理

**技术要点：**
```go
type CommandHandler func(args []string) (interface{}, error)

type CommandRouter struct {
    commands map[string]CommandHandler
}
```

**里程碑检查点：**
- [ ] 能够启动服务器
- [ ] 能够接收 TCP 连接
- [ ] 能够解析 RESP 协议（至少简单字符串）
- [ ] 能够路由命令（即使命令未实现）

---

### Phase 1.2：核心命令实现（Week 2）

#### 任务 1.2.1：存储层实现
**时间估算**：1.5 天

**交付物：**
- [ ] 键值存储结构（`map[string]*Entry`）
- [ ] 线程安全的存储操作（`sync.RWMutex`）
- [ ] 值对象结构（支持字符串类型）
- [ ] 基础操作：Get、Set、Delete、Exists

**技术要点：**
```go
type Entry struct {
    Value      string
    ExpireTime *time.Time  // nil 表示永不过期
}

type Storage struct {
    mu    sync.RWMutex
    data  map[string]*Entry
}
```

#### 任务 1.2.2：SET 命令实现
**时间估算**：0.5 天

**交付物：**
- [ ] SET key value 实现
- [ ] 参数验证（key 和 value 不能为空）
- [ ] 错误处理
- [ ] 单元测试

**功能点：**
- 设置键值对
- 如果键已存在则覆盖
- 返回 `+OK` 响应

#### 任务 1.2.3：GET 命令实现
**时间估算**：0.5 天

**交付物：**
- [ ] GET key 实现
- [ ] 键不存在时返回 `$-1`（nil）
- [ ] 键存在时返回值的批量字符串
- [ ] 单元测试

#### 任务 1.2.4：DEL 命令实现
**时间估算**：0.5 天

**交付物：**
- [ ] DEL key 实现
- [ ] 支持删除多个键（DEL key1 key2 ...）
- [ ] 返回删除的键数量
- [ ] 单元测试

#### 任务 1.2.5：EXISTS 命令实现
**时间估算**：0.5 天

**交付物：**
- [ ] EXISTS key 实现
- [ ] 支持检查多个键（EXISTS key1 key2 ...）
- [ ] 返回存在的键数量
- [ ] 单元测试

**里程碑检查点：**
- [ ] 所有核心命令实现完成
- [ ] 能够通过 redis-cli 执行 SET/GET/DEL/EXISTS
- [ ] 基础单元测试通过

---

### Phase 1.3：功能完善（Week 3）

#### 任务 1.3.1：过期机制实现
**时间估算**：2 天

**交付物：**
- [ ] EXPIRE key seconds 命令
- [ ] TTL key 命令
- [ ] 过期键后台清理（定期扫描或懒删除）
- [ ] GET 时检查过期并删除
- [ ] 单元测试

**技术要点：**
- 懒删除：在访问时检查过期
- 定期清理：后台 goroutine 定期扫描（可选优化）
- 时间精度：支持秒级过期

#### 任务 1.3.2：多客户端并发支持
**时间估算**：1 天

**交付物：**
- [ ] 支持多个客户端同时连接
- [ ] 每个连接独立处理（goroutine per connection）
- [ ] 连接关闭和资源清理
- [ ] 连接数统计

**测试验证：**
- [ ] 使用 redis-cli 打开多个连接
- [ ] 并发 SET/GET 操作验证数据一致性

#### 任务 1.3.3：基础管理命令
**时间估算**：1 天

**交付物：**
- [ ] PING 命令（返回 `+PONG`）
- [ ] QUIT 命令（关闭连接）
- [ ] INFO 命令（简化版，返回基础统计信息）
  - 服务器版本
  - 连接数
  - 键数量
  - 内存使用（粗略估算）

**里程碑检查点：**
- [ ] 过期机制正常工作
- [ ] 多客户端连接稳定
- [ ] 基础管理命令可用

---

### Phase 1.4：测试、优化和文档（Week 4-5）

#### 任务 1.4.1：功能测试
**时间估算**：1 天

**交付物：**
- [ ] 使用 redis-cli 手动测试所有命令
- [ ] 使用主流 Redis 客户端测试（如 Go 的 go-redis、Python 的 redis-py）
- [ ] 边界情况测试（空值、超长键名、特殊字符等）
- [ ] 并发测试（多客户端同时操作）

**测试清单：**
- [ ] SET/GET 基本功能
- [ ] DEL/EXISTS 功能
- [ ] 过期机制（EXPIRE、TTL）
- [ ] 键覆盖场景
- [ ] 不存在的键操作
- [ ] 错误命令处理
- [ ] 连接关闭和重连

#### 任务 1.4.2：性能测试（基础）
**时间估算**：1 天

**交付物：**
- [ ] 使用 redis-benchmark 进行基础性能测试
- [ ] 记录基础指标：
  - QPS（每秒请求数）
  - 延迟（P50、P99）
  - 内存使用
- [ ] 性能测试报告

**测试命令示例：**
```bash
redis-benchmark -h localhost -p 6379 -n 100000 -c 100 -t set,get
```

#### 任务 1.4.3：代码优化和 Bug 修复
**时间估算**：2-3 天

**交付物：**
- [ ] 代码审查和重构
- [ ] 性能热点优化（如果有明显瓶颈）
- [ ] 内存泄漏检查（使用 Go 的 pprof）
- [ ] Bug 修复
- [ ] 代码注释完善

#### 任务 1.4.4：可选优化（如果时间允许）
**时间估算**：1-2 天

**可选优化项（按优先级）：**

1. **数据对齐优化**（低难度，中等收益）
   - 对热点数据结构进行缓存行对齐
   - 使用 `[64]byte` padding 避免伪共享
   - 预期提升：缓存命中率提升 10-20%

2. **CPU 亲和性绑定**（低难度，低收益，单机不明显）
   - 使用 `runtime.LockOSThread()` 绑定 goroutine 到 CPU
   - 预期提升：上下文切换减少（多核场景）

3. **简单内存池**（中等难度，高收益，但需要设计）
   - 为频繁分配的对象（如 Entry）实现对象池
   - 使用 `sync.Pool` 实现
   - 预期提升：GC 压力减少，分配延迟降低

**建议**：如果时间紧张，可以跳过可选优化，留到第二阶段。

#### 任务 1.4.5：文档编写
**时间估算**：1 天

**交付物：**
- [ ] 用户使用文档（如何启动、如何连接）
- [ ] 开发文档（代码结构说明）
- [ ] API 文档（支持的命令列表）
- [ ] 性能测试报告（如果有）

---

## 4. 时间计划表

### 总体时间线

| 阶段 | 周次 | 主要任务 | 里程碑 |
|------|------|---------|--------|
| Phase 1.1 | Week 1 | 项目基础搭建、TCP 服务器、RESP 解析 | 服务器能启动并解析协议 |
| Phase 1.2 | Week 2 | 存储层、核心命令实现 | SET/GET/DEL/EXISTS 可用 |
| Phase 1.3 | Week 3 | 过期机制、多客户端、管理命令 | 功能完整可用 |
| Phase 1.4 | Week 4-5 | 测试、优化、文档 | MVP 版本完成 |

### 详细时间安排

**Week 1（项目搭建）**
- Day 1-2：项目结构 + TCP 服务器
- Day 3-4：RESP 协议解析器
- Day 5：命令路由框架 + 周总结

**Week 2（核心功能）**
- Day 1-2：存储层实现
- Day 2-3：SET/GET 命令
- Day 4：DEL/EXISTS 命令
- Day 5：测试验证 + 周总结

**Week 3（功能完善）**
- Day 1-2：过期机制
- Day 3：多客户端支持
- Day 4：管理命令
- Day 5：集成测试 + 周总结

**Week 4（测试优化）**
- Day 1：功能测试
- Day 2：性能测试
- Day 3-4：代码优化和 Bug 修复
- Day 5：可选优化（如果时间允许）

**Week 5（收尾）**
- Day 1-2：文档编写
- Day 3-4：最终测试和 Bug 修复
- Day 5：项目总结和第二阶段规划

---

## 5. 风险识别和应对

### 5.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| RESP 协议解析复杂 | 中 | 中 | 先实现简化版，逐步完善 |
| 并发安全问题 | 高 | 中 | 充分测试，使用标准库的锁机制 |
| 内存泄漏 | 高 | 低 | 使用 pprof 工具定期检查 |
| 性能不达预期 | 低 | 中 | 第一阶段以功能为主，性能优化放后期 |

### 5.2 进度风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 开发时间超预期 | 中 | 中 | 优先保证核心功能，可选优化后置 |
| 测试时间不足 | 低 | 低 | 边开发边测试，集成测试提前 |

---

## 6. 验收标准

### 6.1 功能验收

- [ ] 所有核心命令（SET/GET/DEL/EXISTS）正常工作
- [ ] 过期机制（EXPIRE/TTL）正常工作
- [ ] 能够被标准 Redis 客户端连接和使用
- [ ] 多客户端并发连接稳定，数据一致
- [ ] 基础错误处理正确

### 6.2 性能验收（定性）

- [ ] 能够处理 100+ 并发连接
- [ ] 单机 GET/SET 操作响应正常（无明显卡顿）
- [ ] 内存使用合理（无明显泄漏）

### 6.3 质量验收

- [ ] 代码通过基础代码审查
- [ ] 有基础的单元测试
- [ ] 有基本的文档（README、使用说明）
- [ ] 代码风格符合规范

---

## 7. 下一步规划

### 第一阶段完成后

1. **性能量化测试**
   - 详细的性能基准测试
   - 与 Redis 性能对比
   - 识别性能瓶颈

2. **第二阶段规划**
   - 根据第一阶段经验和性能测试结果
   - 制定第二阶段优化计划
   - 考虑实现更多数据结构或性能优化

---

**文档版本**：v1.0  
**创建日期**：2024  
**维护者**：redisX 项目组  
**关联文档**：
- 《技术原理分析.md》
- 《技术实施可行性分析.md》
- 《技术架构设计.md》
- 《编码规范.md》

